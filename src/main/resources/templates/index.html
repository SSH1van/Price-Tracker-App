<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ru">
<head>
    <title>График цен</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
</head>
<body>
<h1>Товары</h1>
<ul id="productList">
    <li th:each="product : ${data.keySet()}" th:text="${product}" onclick="showChart(this.textContent)" style="cursor: pointer"></li>
</ul>

<h2 id="selectedProduct">Выберите товар для просмотра динамики цен</h2>
<canvas id="priceChart" style="margin: 20px"></canvas>

<script th:inline="javascript">
    const data = [[${data}]];

    // Ссылка на объект графика
    let chart;

    function formatDate(input) {
        const [datePart, timePart] = input.split('_');
        const [day, month, year] = datePart.split('-');
        const [hour, minute, second] = timePart.split('-');

        const date = new Date(year, month - 1, day, hour, minute, second);

        const formattedDate = date.toISOString().slice(0, 19);

        return formattedDate;
    }

    function showChart(product) {
        // Устанавливаем заголовок
        document.getElementById('selectedProduct').textContent = `Динамика цен: ${product}`;
        
        // Получаем данные для выбранного товара
        const productData = data[product] || [];

        const dataset = {
            label: product,
            data: productData.map(point => ({
                x: new Date(formatDate(point.timestamp)), // Временная метка
                y: point.price // Цена
            })),
            borderColor: 'rgba(75, 192, 192, 1)',
            borderWidth: 2,
            fill: false
        };

        // Если график уже существует, обновляем его
        if (chart) {
            chart.data.datasets = [dataset];
            chart.update();
        } else {
            // Создаём график
            const ctx = document.getElementById('priceChart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'line',
                data: { datasets: [dataset] },
                options: {
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'day',
                            },
                            title: {
                                display: true,
                                text: 'Дата'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Цена'
                            }
                        }
                    }
                }
            });
        }
    }
</script>
</body>
</html>
